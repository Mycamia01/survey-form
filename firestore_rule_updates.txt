rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üë§ USERS COLLECTION
    match /users/{userId} {
      allow read: if request.auth != null &&
        (request.auth.uid == userId || request.auth.token.role == "admin");

      allow create: if request.auth != null && request.auth.uid == userId;

      allow update, delete: if request.auth != null &&
        (request.auth.uid == userId || request.auth.token.role == "admin");
    }

    // üìã SURVEYS COLLECTION
    match /surveys/{surveyId} {
      // Admin can read all surveys
      // system_user can only read their own
      allow read: if request.auth != null &&
        (request.auth.token.role == "admin" || request.auth.uid == resource.data.createdBy);

      // Admin can write any survey
      allow create, update, delete: if request.auth.token.role == "admin";

      // system_user can create surveys
      allow create: if request.auth.token.role == "system_user";

      // system_user can update/delete only their own surveys
      allow update, delete: if request.auth.token.role == "system_user" &&
                            request.auth.uid == resource.data.createdBy;
    }

    // üì• RECIPIENTS COLLECTION
    match /recipients/{recipientId} {
      // Admin and system_user can create
      allow create: if request.auth != null &&
        (request.auth.token.role == "admin" || request.auth.token.role == "system_user");

      // Admin can access all, system_user only their own
      allow read, update, delete: if request.auth != null &&
        (request.auth.token.role == "admin" || request.auth.uid == resource.data.uploadedBy);
    }

    // ‚úÖ RESPONSES COLLECTION
    match /responses/{responseId} {
      // Anyone (even unauthenticated) can submit responses
      allow create: if true;

      // Admin and system_user can read
      allow read: if request.auth != null &&
        (request.auth.token.role == "admin" || request.auth.token.role == "system_user");
    }

    // üì§ NOTIFICATIONS COLLECTION
    match /notifications/{notificationId} {
      allow read, write: if request.auth.token.role == "admin";
    }

    // üè∑Ô∏è CATEGORIES COLLECTION
    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == "admin";
    }
  }
}
